<html lang='en'>
  <head>
    <meta charset='UTF-8' />
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <title>StoComm</title>
    <link
      href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css'
      rel='stylesheet'
      integrity='sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3'
      crossorigin='anonymous'
    />

    <link rel='stylesheet' href='/stylesheet/normalize.css' />
    <link rel='stylesheet' href='/stylesheet/navbar.css' />
    <link rel='stylesheet' href='/stylesheet/{{style}}' />
  </head>

  <body>
    <div class='navbar shadow-sm'>
      <a href='/hot-rooms'>
        {{! <h3>StoComm</h3> }}
        <img src='/img/logo.png' alt='' id='logo' />
      </a>
      <div class='functional-part'>
        <a class="quick-start text-secondary rounded" href="/explore">
          瀏覽熱門觀點
        </a>
        <a class="quick-start text-secondary rounded" data-bs-toggle="modal" data-bs-target="#war-room-check">
          {{!-- <img
            src='/img/warroom.png'
            alt=''
            id='war-room-link'
            data-toggle='tooltip'
            data-placement='bottom'
            title='打開研究室'
          /> --}}
          快速開啟研究室
        </a>
        <div class='dropdown'>
          <a
            id='dropdownMenuLink'
            data-bs-toggle='dropdown'
            aria-expanded='false'
          >
            <img src='/img/member.png' alt='' id='member-link' />
          </a>
          <ul class='dropdown-menu' aria-labelledby='dropdownMenuButton1'>
            <li><a class='dropdown-item' href='/member'>個人資料</a></li>
            <li><a class='dropdown-item' href='#'>編輯個人資料</a></li>
            <li><a
                class='dropdown-item'
                href='#'
                id='navbar-logou'
              >登出</a></li>
          </ul>
        </div>
      </div>

      <div class='home-login-btns'>
        <button
          type='button'
          class='btn btn-secondary mx-3'
          data-bs-toggle='modal'
          data-bs-target='#login-modal'
        >登入</button>
        <button
          type='button'
          class='btn btn-outline-secondary mx-3'
          data-bs-toggle='modal'
          data-bs-target='#signup-modal'
        >註冊</button>
      </div>
    </div>

    {{! modal }}
  <div
    class='modal fade'
    id='war-room-check'
    tabindex='-1'
    aria-labelledby='exampleModalLabel'
    aria-hidden='true'
  >
    <div class='modal-dialog'>
      <div class='modal-content'>
        <div class='modal-header'>
          <h5 class='modal-title' id='war-room-check-title'>開啟我的研究室</h5>
          <button
            type='button'
            class='btn-close'
            data-bs-dismiss='modal'
            aria-label='Close'
          ></button>
        </div>
        <div class='modal-body'>
          <h2 class="welcome-msg js-signup-msg"></h3>
            <form class="war-room-check-data">
              <label for="staticEmail" class="col-sm-12 col-form-label mt-3"
                >研究室名稱</label
              >
              <input
                type="text"
                class="form-control"
                id="signup-user-mail"
                value=""
                name="war_room_title"
              />

              <label for="inputPassword" class="col-sm-12 col-form-label mt-3"
              >股票名稱或代碼</label>
              <input
                type="text"
                class="form-control"
                id="signup-user-password"
                placeholder="請輸入股票名稱或代碼"
                name="stock_name_code"/>

              <input type="hidden" id="user_id" name="user_id">
              <button type="submit" class="btn btn-primary mb-2 mt-4" id="js-create-war-room-btn">送出</button>
            </form>
        </div>
      </div>
    </div>
  </div>

    <!-- JS -->
    <script
      src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js'
      integrity='sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p'
      crossorigin='anonymous'
    ></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src='/javascript/template/universal.js'></script>
    <script>
      document.querySelector('#navbar-logou').addEventListener('click', (e) => {
      localStorage.removeItem('user');localStorage.removeItem('access_token');
      window.location.href = '/' })
    </script>

    {{{body}}}

    <script>
      document.querySelector('#js-create-war-room-btn').addEventListener('click', async (e) => {
        e.preventDefault()
        const accessToken = localStorage.getItem('access_token')
        
        const userResponse = await fetch('/api/1.0/user/user_auth', {
          method: 'GET',
          headers: {
            Authorization: 'Bearer ' + accessToken
          }
        })

        if (userResponse.status !== 200) {
          await Swal.fire({
            icon: 'error',
            title: '請重新登入!',
            confirmButtonColor: '#315375'
          })
          return 
        }

        const userResult = await userResponse.json()
        const userData = userResult.data

        document.querySelector('#user_id').value = userData.id
        const createData = new FormData(document.querySelector('.war-room-check-data'))
        const roomResponse = await fetch('/api/1.0/war_room/create_war_room', {
          method: 'POST',
          Authorization: 'Bearer ' + accessToken,
          body: createData
        })
        const roomresult = await roomResponse.json()
        console.log(roomresult)

        if (roomResponse.status !== 200) {
          await Swal.fire({
            icon: 'error',
            title: roomresult.error,
            confirmButtonColor: '#315375'
          })
          return 
        }

        const roomId = roomresult.data.insertId
        const stockCode = roomresult.data.stock_code
        window.location.href = `/war-room?roomId=${roomId}&stockCode=${stockCode}`
      })

      
    </script>
  </body>

</html>